<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управление светофорами Актобе</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <style>
        /* Ваши стили остаются без изменений */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            background: linear-gradient(135deg, #2c3e50, #4a6491);
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .main-content {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .map-container {
            flex: 2;
            min-width: 300px;
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        #map {
            width: 100%;
            height: 500px;
            border-radius: 8px;
        }
        
        .controls {
            flex: 1;
            min-width: 300px;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        input, select, button {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }
        
        input:focus, select:focus {
            border-color: #4a6491;
            outline: none;
        }
        
        button {
            background: linear-gradient(135deg, #2c3e50, #4a6491);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .traffic-list {
            margin-top: 30px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .traffic-item {
            background: #f8f9fa;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 4px solid #4a6491;
            transition: all 0.3s;
        }
        
        .traffic-item.selected {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        
        .timer {
            font-size: 18px;
            font-weight: bold;
            margin: 8px 0;
        }
        
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .status-red {
            background-color: #ff4757;
            color: white;
        }
        
        .status-green {
            background-color: #2ed573;
            color: white;
        }
        
        .delete-btn {
            background: #ff4757;
            margin-top: 8px;
            padding: 8px;
            font-size: 14px;
        }
        
        .edit-btn {
            background: #ffa502;
            margin-top: 8px;
            padding: 8px;
            font-size: 14px;
        }
        
        .move-btn {
            background: #2ed573;
            margin-top: 8px;
            padding: 8px;
            font-size: 14px;
        }
        
        .instructions {
            background: #e9eef5;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .instructions h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .instructions ul {
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
        
        .traffic-icon {
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            transition: all 0.3s;
        }
        
        .traffic-icon.selected {
            transform: scale(1.3);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }
        
        .current-selection {
            background-color: #ffeaa7;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: none;
        }
        
        .color-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .color-option {
            flex: 1;
            text-align: center;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .color-option.red {
            background-color: #ff6b6b;
            color: white;
        }
        
        .color-option.green {
            background-color: #51cf66;
            color: white;
        }
        
        .color-option.selected {
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        }
        
        .edit-mode {
            background-color: #ffeaa7;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: none;
        }
        
        .duration-settings {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .duration-group {
            margin-bottom: 0;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
        }
        
        .button-group button {
            flex: 1;
        }
        
        .storage-info {
            margin-top: 15px;
            padding: 10px;
            background-color: #e9eef5;
            border-radius: 6px;
            text-align: center;
            font-size: 14px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 10px;
            background-color: #ffeaa7;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .duration-settings {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Управление светофорами Актобе</h1>
            <p>Добавляйте, редактируйте и управляйте светофорами на карте</p>
        </header>
        
        <div class="loading" id="loading">
            <p>Загрузка данных...</p>
        </div>
        
        <div class="main-content">
            <div class="map-container">
                <div id="map"></div>
            </div>
            
            <div class="controls">
                <div class="current-selection" id="current-selection">
                    <h3>Новый светофор</h3>
                    <p>Адрес: <span id="selected-address">не выбран</span></p>
                    <p>Координаты: <span id="selected-coords">не выбраны</span></p>
                </div>
                
                <div class="edit-mode" id="edit-mode">
                    <h3>Редактирование светофора</h3>
                    <p>Адрес: <span id="edit-address">не выбран</span></p>
                    <p>Координаты: <span id="edit-coords">не выбраны</span></p>
                </div>
                
                <h2 id="form-title">Настройки светофора</h2>
                <div class="form-group">
                    <label for="light-address">Адрес:</label>
                    <input type="text" id="light-address" placeholder="Адрес определится автоматически">
                </div>
                
                <div class="form-group">
                    <label>Текущий цвет:</label>
                    <div class="color-selector">
                        <div class="color-option red selected" data-color="red">Красный</div>
                        <div class="color-option green" data-color="green">Зеленый</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="time-left">Осталось секунд:</label>
                    <input type="number" id="time-left" min="0" value="30">
                </div>
                
                <div class="duration-settings">
                    <div class="duration-group">
                        <label for="red-time">Длительность красного (сек):</label>
                        <input type="number" id="red-time" min="5" value="30">
                    </div>
                    
                    <div class="duration-group">
                        <label for="green-time">Длительность зеленого (сек):</label>
                        <input type="number" id="green-time" min="5" value="40">
                    </div>
                </div>
                
                <div class="button-group">
                    <button id="add-light">Добавить светофор</button>
                    <button id="update-light" style="display: none;">Сохранить изменения</button>
                    <button id="cancel-edit" style="display: none;">Отменить</button>
                    <button id="delete-light" style="display: none; background: #ff4757;">Удалить светофор</button>
                </div>
                
                <div class="storage-info">
                    <p>Данные сохраняются в Firebase Realtime Database</p>
                    <button id="clear-storage" style="background: #ff4757; margin-top: 5px;">Очистить все данные</button>
                </div>
                
                <div class="traffic-list">
                    <h2>Активные светофоры</h2>
                    <div id="lights-container">
                        <!-- Список светофоров будет здесь -->
                    </div>
                </div>
                
                <div class="instructions">
                    <h3>Как использовать:</h3>
                    <ul>
                        <li>Кликните на карте, где нужно разместить светофор</li>
                        <li>Адрес определится автоматически</li>
                        <li>Выберите текущий цвет и оставшееся время</li>
                        <li>Настройте длительность сигналов и нажмите "Добавить светофор"</li>
                        <li>Для редактирования нажмите "Редактировать" в списке или кликните на светофор на карте</li>
                        <li>Для удаления нажмите "Удалить" в списке или используйте кнопку удаления в режиме редактирования</li>
                        <li>Все данные автоматически сохраняются в Firebase</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Конфигурация Firebase
            const firebaseConfig = {
                apiKey: "AIzaSyAYUDlf8xv-uOyz0qcWi9iK2_837OK84mg",
                authDomain: "mapsandpass.firebaseapp.com",
                projectId: "mapsandpass",
                storageBucket: "mapsandpass.firebasestorage.app",
                messagingSenderId: "985446917647",
                appId: "1:985446917647:web:372aaad11f1607ed1ea57a",
                measurementId: "G-G46S0Y6V1K"
            };

            // Инициализация Firebase
            firebase.initializeApp(firebaseConfig);
            const database = firebase.database();
            
            // Инициализация карты с центром в Актобе
            const map = L.map('map').setView([50.2839, 57.1667], 13);
            
            // Добавление слоя OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            const addButton = document.getElementById('add-light');
            const updateButton = document.getElementById('update-light');
            const cancelButton = document.getElementById('cancel-edit');
            const deleteButton = document.getElementById('delete-light');
            const clearStorageButton = document.getElementById('clear-storage');
            const lightsContainer = document.getElementById('lights-container');
            const currentSelection = document.getElementById('current-selection');
            const editMode = document.getElementById('edit-mode');
            const selectedAddress = document.getElementById('selected-address');
            const selectedCoords = document.getElementById('selected-coords');
            const editAddress = document.getElementById('edit-address');
            const editCoords = document.getElementById('edit-coords');
            const formTitle = document.getElementById('form-title');
            const colorOptions = document.querySelectorAll('.color-option');
            const timeLeftInput = document.getElementById('time-left');
            const redTimeInput = document.getElementById('red-time');
            const greenTimeInput = document.getElementById('green-time');
            const loadingElement = document.getElementById('loading');
            
            let lights = {};
            let selectedLatLng = null;
            let currentColor = 'red';
            let editingLightId = null;
            let movingLightId = null;
            let isInitialLoad = true;
            
            // Показываем индикатор загрузки
            loadingElement.style.display = 'block';
            
            // Обработчик выбора цвета
            colorOptions.forEach(option => {
                option.addEventListener('click', function() {
                    colorOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    currentColor = this.getAttribute('data-color');
                });
            });
            
            // Обработчик кнопки очистки базы данных
            clearStorageButton.addEventListener('click', function() {
                if (confirm("Вы уверены, что хотите удалить все данные светофоров? Это действие нельзя отменить.")) {
                    // Удаляем все данные из Firebase
                    database.ref('trafficLights').remove()
                        .then(() => {
                            console.log("Все данные удалены из Firebase");
                            // Очищаем локальные данные
                            for (const id in lights) {
                                if (lights[id].marker && lights[id].marker.remove) {
                                    lights[id].marker.remove();
                                }
                                if (lights[id].intervalId) {
                                    clearInterval(lights[id].intervalId);
                                }
                            }
                            lights = {};
                            lightsContainer.innerHTML = '';
                        })
                        .catch(error => {
                            console.error("Ошибка при удалении данных: ", error);
                            alert("Не удалось удалить данные: " + error.message);
                        });
                }
            });
            
            // Обработчик клика по карте для выбора места
            map.on('click', function(e) {
                if (movingLightId) {
                    // Режим перемещения светофора
                    moveTrafficLight(movingLightId, e.latlng);
                    return;
                }
                
                selectedLatLng = e.latlng;
                
                // Показываем блок с выбранным местоположением
                currentSelection.style.display = 'block';
                selectedCoords.textContent = `${selectedLatLng.lat.toFixed(6)}, ${selectedLatLng.lng.toFixed(6)}`;
                selectedAddress.textContent = "определяется...";
                
                // Запрашиваем адрес по координатам (обратное геокодирование)
                fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${selectedLatLng.lat}&lon=${selectedLatLng.lng}&accept-language=ru`)
                    .then(response => response.json())
                    .then(data => {
                        const address = data.display_name || "Адрес не определен";
                        selectedAddress.textContent = address;
                        document.getElementById('light-address').value = address;
                    })
                    .catch(error => {
                        console.error('Ошибка получения адреса:', error);
                        selectedAddress.textContent = "ошибка определения";
                        document.getElementById('light-address').value = `Широта: ${selectedLatLng.lat.toFixed(6)}, Долгота: ${selectedLatLng.lng.toFixed(6)}`;
                    });
            });
            
            // Обработчик кнопки добавления светофора
            addButton.addEventListener('click', function() {
                if (!selectedLatLng) {
                    alert("Сначала выберите местоположение на карте!");
                    return;
                }
                
                const address = document.getElementById('light-address').value;
                const timeLeft = parseInt(timeLeftInput.value);
                const redTime = parseInt(redTimeInput.value);
                const greenTime = parseInt(greenTimeInput.value);
                
                if (!address) {
                    alert("Пожалуйста, укажите адрес светофора");
                    return;
                }
                
                if (redTime < 5 || greenTime < 5) {
                    alert("Длительность сигнала должна быть не менее 5 секунд");
                    return;
                }
                
                // Создаем светофор
                createTrafficLight(selectedLatLng, address, redTime, greenTime, currentColor, timeLeft);
                
                // Сбрасываем форму
                resetForm();
            });
            
            // Обработчик кнопки сохранения изменений
            updateButton.addEventListener('click', function() {
                if (!editingLightId) return;
                
                const address = document.getElementById('light-address').value;
                const timeLeft = parseInt(timeLeftInput.value);
                const redTime = parseInt(redTimeInput.value);
                const greenTime = parseInt(greenTimeInput.value);
                
                if (!address) {
                    alert("Пожалуйста, укажите адрес светофора");
                    return;
                }
                
                if (redTime < 5 || greenTime < 5) {
                    alert("Длительность сигнала должна быть не менее 5 секунд");
                    return;
                }
                
                // Обновляем светофор
                updateTrafficLight(editingLightId, address, redTime, greenTime, currentColor, timeLeft);
                
                // Сбрасываем форму
                resetForm();
                exitEditMode();
            });
            
            // Обработчик кнопки отмены редактирования
            cancelButton.addEventListener('click', function() {
                resetForm();
                exitEditMode();
            });
            
            // Обработчик кнопки удаления светофора
            deleteButton.addEventListener('click', function() {
                if (!editingLightId) return;
                
                if (confirm("Вы уверены, что хотите удалить этот светофор?")) {
                    deleteTrafficLight(editingLightId);
                    resetForm();
                    exitEditMode();
                }
            });
            
            // Функция сохранения светофоров в Firebase
            function saveTrafficLightToFirebase(light) {
                const lightData = {
                    id: light.id,
                    address: light.address,
                    latlng: light.latlng,
                    redTime: light.redTime,
                    greenTime: light.greenTime,
                    currentColor: light.currentColor,
                    timeLeft: light.timeLeft
                };
                
                // Сохраняем в Firebase
                database.ref('trafficLights/' + light.id).set(lightData)
                    .then(() => {
                        console.log('Светофор сохранен в Firebase:', light.id);
                    })
                    .catch(error => {
                        console.error('Ошибка сохранения светофора в Firebase: ', error);
                    });
            }
            
            // Функция загрузки светофоров из Firebase
            function loadTrafficLights() {
                database.ref('trafficLights').on('value', (snapshot) => {
                    const data = snapshot.val();
                    
                    if (data) {
                        // Очищаем текущие светофоры только при первоначальной загрузке
                        if (isInitialLoad) {
                            for (const id in lights) {
                                if (lights[id].marker) {
                                    map.removeLayer(lights[id].marker);
                                }
                                if (lights[id].intervalId) {
                                    clearInterval(lights[id].intervalId);
                                }
                            }
                            lights = {};
                            lightsContainer.innerHTML = '';
                        }
                        
                        // Добавляем или обновляем светофоры из базы данных
                        for (const id in data) {
                            const lightData = data[id];
                            
                            if (lights[id]) {
                                // Обновляем существующий светофор
                                updateLocalTrafficLight(lightData);
                            } else {
                                // Создаем новый светофор
                                createLocalTrafficLight(lightData);
                            }
                        }
                        
                        // Удаляем светофоры, которых нет в Firebase
                        if (!isInitialLoad) {
                            for (const id in lights) {
                                if (!data[id]) {
                                    removeLocalTrafficLight(id);
                                }
                            }
                        }
                        
                        console.log('Данные светофоров загружены из Firebase');
                        loadingElement.style.display = 'none';
                        isInitialLoad = false;
                    } else {
                        // Нет данных в Firebase
                        lightsContainer.innerHTML = '';
                        loadingElement.style.display = 'none';
                        isInitialLoad = false;
                    }
                }, (error) => {
                    console.error('Ошибка загрузки данных из Firebase:', error);
                    loadingElement.style.display = 'none';
                    isInitialLoad = false;
                });
            }
            
            // Функция создания светофора на основе данных из Firebase
            function createLocalTrafficLight(lightData) {
                const latlng = L.latLng(lightData.latlng.lat, lightData.latlng.lng);
                const id = lightData.id;
                
                // Определяем цвет иконки
                const iconColor = lightData.currentColor === 'red' ? '#ff4757' : '#2ed573';
                
                // Создаем иконку для светофора
                const trafficIcon = L.divIcon({
                    className: 'traffic-icon',
                    html: `<div style="background-color: ${iconColor}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white;"></div>`,
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });
                
                // Добавляем маркер на карту
                const marker = L.marker(latlng, { 
                    icon: trafficIcon,
                    draggable: true
                }).addTo(map);
                
                // Добавляем всплывающую подсказку
                marker.bindPopup(`
                    <strong>${lightData.address}</strong><br>
                    Красный: ${lightData.redTime}сек, Зеленый: ${lightData.greenTime}сек<br>
                    Текущий статус: <span style="color: ${lightData.currentColor === 'red' ? '#ff4757' : '#2ed573'};">${lightData.currentColor === 'red' ? 'Красный' : 'Зеленый'}</span>
                `);
                
                // Обработчик клика на маркер для редактирования
                marker.on('click', function(e) {
                    editTrafficLight(id);
                    L.DomEvent.stopPropagation(e);
                });
                
                // Обработчик перемещения маркера
                marker.on('dragend', function() {
                    const newLatLng = marker.getLatLng();
                    moveTrafficLight(id, newLatLng);
                });
                
                // Сохраняем данные о светофоре
                lights[id] = {
                    id: id,
                    address: lightData.address,
                    latlng: latlng,
                    redTime: lightData.redTime,
                    greenTime: lightData.greenTime,
                    currentColor: lightData.currentColor,
                    timeLeft: lightData.timeLeft,
                    marker: marker,
                    intervalId: null
                };
                
                // Добавляем в список
                addToLightsList(id);
                
                // Запускаем таймер, если время больше 0
                if (lightData.timeLeft > 0) {
                    startTrafficLightTimer(id);
                }
            }
            
            // Функция обновления локального светофора
            function updateLocalTrafficLight(lightData) {
                const light = lights[lightData.id];
                if (!light) return;
                
                // Останавливаем текущий таймер
                if (light.intervalId) {
                    clearInterval(light.intervalId);
                }
                
                // Обновляем данные
                light.address = lightData.address;
                light.redTime = lightData.redTime;
                light.greenTime = lightData.greenTime;
                light.currentColor = lightData.currentColor;
                light.timeLeft = lightData.timeLeft;
                
                // Обновляем позицию маркера
                light.marker.setLatLng([lightData.latlng.lat, lightData.latlng.lng]);
                
                // Обновляем иконку маркера
                const iconColor = lightData.currentColor === 'red' ? '#ff4757' : '#2ed573';
                light.marker.setIcon(L.divIcon({
                    className: 'traffic-icon',
                    html: `<div style="background-color: ${iconColor}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white;"></div>`,
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                }));
                
                // Обновляем всплывающую подсказку
                light.marker.setPopupContent(`
                    <strong>${lightData.address}</strong><br>
                    Красный: ${lightData.redTime}сек, Зеленый: ${lightData.greenTime}сек<br>
                    Текущий статус: <span style="color: ${lightData.currentColor === 'red' ? '#ff4757' : '#2ed573'};">${lightData.currentColor === 'red' ? 'Красный' : 'Зеленый'}</span>
                `);
                
                // Обновляем отображение в списке
                updateLightDisplay(lightData.id);
                
                // Запускаем таймер, если время больше 0
                if (lightData.timeLeft > 0) {
                    startTrafficLightTimer(lightData.id);
                }
            }
            
            // Функция удаления локального светофора
            function removeLocalTrafficLight(id) {
                const light = lights[id];
                if (!light) return;
                
                // Останавливаем таймер
                if (light.intervalId) {
                    clearInterval(light.intervalId);
                }
                
                // Удаляем с карты
                if (light.marker && light.marker.remove) {
                    light.marker.remove();
                }
                
                // Удаляем из списка
                const item = document.querySelector(`.traffic-item[data-id="${id}"]`);
                if (item) {
                    item.remove();
                }
                
                // Удаляем из хранилища
                delete lights[id];
            }
            
            // Функция создания светофора
            function createTrafficLight(latlng, address, redTime, greenTime, color, timeLeft) {
                const id = 'light_' + Date.now();
                
                // Создаем объект светофора
                const lightData = {
                    id: id,
                    address: address,
                    latlng: { lat: latlng.lat, lng: latlng.lng },
                    redTime: redTime,
                    greenTime: greenTime,
                    currentColor: color,
                    timeLeft: timeLeft
                };
                
                // Сохраняем в Firebase
                database.ref('trafficLights/' + id).set(lightData)
                    .then(() => {
                        console.log('Светофор сохранен в Firebase:', id);
                    })
                    .catch(error => {
                        console.error('Ошибка сохранения светофора в Firebase: ', error);
                    });
            }
            
            // Функция обновления светофора
            function updateTrafficLight(id, address, redTime, greenTime, color, timeLeft) {
                const light = lights[id];
                if (!light) return;
                
                // Обновляем данные
                const updateData = {
                    address: address,
                    redTime: redTime,
                    greenTime: greenTime,
                    currentColor: color,
                    timeLeft: timeLeft
                };
                
                // Обновляем в Firebase
                database.ref('trafficLights/' + id).update(updateData)
                    .then(() => {
                        console.log('Светофор обновлен в Firebase:', id);
                    })
                    .catch(error => {
                        console.error('Ошибка обновления светофора в Firebase: ', error);
                    });
            }
            
            // Функция перемещения светофора
            function moveTrafficLight(id, newLatLng) {
                const light = lights[id];
                if (!light) return;
                
                // Обновляем координаты
                light.latlng = newLatLng;
                light.marker.setLatLng(newLatLng);
                
                // Запрашиваем новый адрес
                fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${newLatLng.lat}&lon=${newLatLng.lng}&accept-language=ru`)
                    .then(response => response.json())
                    .then(data => {
                        const address = data.display_name || "Адрес не определен";
                        
                        // Обновляем в Firebase
                        database.ref('trafficLights/' + id).update({
                            latlng: { lat: newLatLng.lat, lng: newLatLng.lng },
                            address: address
                        }).then(() => {
                            console.log('Светофор перемещен в Firebase:', id);
                        }).catch(error => {
                            console.error('Ошибка перемещения светофора в Firebase: ', error);
                        });
                    })
                    .catch(error => {
                        console.error('Ошибка получения адреса:', error);
                    });
                
                // Выходим из режима перемещения
                movingLightId = null;
            }
            
            // Функция удаления светофора
            function deleteTrafficLight(id) {
                // Удаляем из Firebase
                database.ref('trafficLights/' + id).remove()
                    .then(() => {
                        console.log('Светофор удален из Firebase:', id);
                    })
                    .catch(error => {
                        console.error('Ошибка удаления светофора из Firebase: ', error);
                    });
            }
            
            // Функция добавления светофора в список
            function addToLightsList(id) {
                const light = lights[id];
                
                const item = document.createElement('div');
                item.className = 'traffic-item';
                item.setAttribute('data-id', id);
                item.innerHTML = `
                    <h3>${light.address}</h3>
                    <div class="timer">Осталось: ${light.timeLeft}с</div>
                    <div class="status status-${light.currentColor}">${light.currentColor === 'red' ? 'Красный' : 'Зеленый'}</div>
                    <div><small>Красный: ${light.redTime}с, Зеленый: ${light.greenTime}с</small></div>
                    <button class="edit-btn" data-id="${id}">Редактировать</button>
                    <button class="delete-btn" data-id="${id}">Удалить</button>
                `;
                
                lightsContainer.appendChild(item);
                
                // Обработчик редактирования
                item.querySelector('.edit-btn').addEventListener('click', function() {
                    editTrafficLight(id);
                });
                
                // Обработчик удаления
                item.querySelector('.delete-btn').addEventListener('click', function() {
                    deleteTrafficLight(id);
                });
                
                // Обработчик клика на элемент списка
                item.addEventListener('click', function(e) {
                    if (e.target.tagName !== 'BUTTON') {
                        editTrafficLight(id);
                    }
                });
            }
            
            // Функция редактирования светофора
            function editTrafficLight(id) {
                const light = lights[id];
                
                // Снимаем выделение со всех элементов
                document.querySelectorAll('.traffic-item').forEach(item => {
                    item.classList.remove('selected');
                });
                
                // Выделяем текущий элемент
                document.querySelector(`.traffic-item[data-id="${id}"]`).classList.add('selected');
                
                // Снимаем выделение со всех маркеров
                for (const lightId in lights) {
                    if (lights[lightId].marker && lights[lightId].marker._icon) {
                        lights[lightId].marker._icon.classList.remove('selected');
                    }
                }
                
                // Выделяем маркер текущего светофора
                light.marker._icon.classList.add('selected');
                
                // Входим в режим редактирования
                editingLightId = id;
                
                // Заполняем форму данными светофора
                document.getElementById('light-address').value = light.address;
                timeLeftInput.value = light.timeLeft;
                redTimeInput.value = light.redTime;
                greenTimeInput.value = light.greenTime;
                
                // Устанавливаем текущий цвет
                colorOptions.forEach(opt => opt.classList.remove('selected'));
                document.querySelector(`.color-option.${light.currentColor}`).classList.add('selected');
                currentColor = light.currentColor;
                
                // Показываем информацию о редактируемом светофоре
                editAddress.textContent = light.address;
                editCoords.textContent = `${light.latlng.lat.toFixed(6)}, ${light.latlng.lng.toFixed(6)}`;
                
                // Переключаем интерфейс в режим редактирования
                currentSelection.style.display = 'none';
                editMode.style.display = 'block';
                formTitle.textContent = 'Редактирование светофора';
                addButton.style.display = 'none';
                updateButton.style.display = 'block';
                cancelButton.style.display = 'block';
                deleteButton.style.display = 'block';
                
                // Центрируем карту на выбранном светофоре
                map.setView(light.latlng, map.getZoom());
            }
            
            // Функция выхода из режима редактирования
            function exitEditMode() {
                // Снимаем выделение со всех элементов
                document.querySelectorAll('.traffic-item').forEach(item => {
                    item.classList.remove('selected');
                });
                
                // Снимаем выделение со всех маркеров
                for (const lightId in lights) {
                    if (lights[lightId].marker && lights[lightId].marker._icon) {
                        lights[lightId].marker._icon.classList.remove('selected');
                    }
                }
                
                editingLightId = null;
                editMode.style.display = 'none';
                formTitle.textContent = 'Настройки светофора';
                addButton.style.display = 'block';
                updateButton.style.display = 'none';
                cancelButton.style.display = 'none';
                deleteButton.style.display = 'none';
            }
            
            // Функция сброса формы
            function resetForm() {
                document.getElementById('light-address').value = '';
                timeLeftInput.value = '30';
                redTimeInput.value = '30';
                greenTimeInput.value = '40';
                
                colorOptions.forEach(opt => opt.classList.remove('selected'));
                document.querySelector('.color-option.red').classList.add('selected');
                currentColor = 'red';
                
                currentSelection.style.display = 'none';
                selectedLatLng = null;
            }
            
            // Функция запуска таймера светофора
            function startTrafficLightTimer(id) {
                const light = lights[id];
                
                // Останавливаем предыдущий таймер, если он был
                if (light.intervalId) {
                    clearInterval(light.intervalId);
                }
                
                light.intervalId = setInterval(function() {
                    light.timeLeft--;
                    
                    // Обновляем отображение
                    updateLightDisplay(id);
                    
                    // Если время истекло, переключаем цвет
                    if (light.timeLeft <= 0) {
                        if (light.currentColor === 'red') {
                            light.currentColor = 'green';
                            light.timeLeft = light.greenTime;
                        } else {
                            light.currentColor = 'red';
                            light.timeLeft = light.redTime;
                        }
                        
                        // Обновляем иконку маркера
                        const iconColor = light.currentColor === 'red' ? '#ff4757' : '#2ed573';
                        light.marker.setIcon(L.divIcon({
                            className: 'traffic-icon',
                            html: `<div style="background-color: ${iconColor}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white;"></div>`,
                            iconSize: [24, 24],
                            iconAnchor: [12, 12]
                        }));
                        
                        // Обновляем всплывающую подсказку
                        light.marker.setPopupContent(`
                            <strong>${light.address}</strong><br>
                            Красный: ${light.redTime}сек, Зеленый: ${light.greenTime}сек<br>
                            Текущий статус: <span style="color: ${light.currentColor === 'red' ? '#ff4757' : '#2ed573'};">${light.currentColor === 'red' ? 'Красный' : 'Зеленый'}</span>
                        `);
                        
                        // Обновляем отображение
                        updateLightDisplay(id);
                        
                        // Сохраняем данные в Firebase при смене цвета
                        database.ref('trafficLights/' + id).update({
                            currentColor: light.currentColor,
                            timeLeft: light.timeLeft
                        }).catch(error => {
                            console.error('Ошибка обновления таймера светофора: ', error);
                        });
                    }
                }, 1000);
            }
            
            // Функция обновления отображения светофора
            function updateLightDisplay(id) {
                const light = lights[id];
                const item = document.querySelector(`.traffic-item[data-id="${id}"]`);
                
                if (item) {
                    const timer = item.querySelector('.timer');
                    const status = item.querySelector('.status');
                    
                    if (timer) timer.textContent = `Осталось: ${light.timeLeft}с`;
                    if (status) {
                        status.textContent = light.currentColor === 'red' ? 'Красный' : 'Зеленый';
                        status.className = `status status-${light.currentColor}`;
                    }
                }
            }
            
            // Загружаем сохраненные светофоры при запуске
            loadTrafficLights();
        });
    </script>
</body>
</html>
